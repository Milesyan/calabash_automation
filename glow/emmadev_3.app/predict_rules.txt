-266860366612057925
function e(e,t){return e%t}function t(e,p,t,l,n,o){e[0].pb=l,e[0].cl=n,e[0].pl=o,e[0].ol=14,p[0].pb=l,p[0].cl=n,p[0].pl=o,p[0].ol=14,t[0].pb=l,t[0].cl=n,t[0].pl=o,t[0].ol=14}function l(e,p,l,d,n,o,u){"string"==typeof n&&(n=L(n)),e=a(e),p=a(p),l=a(l);var v=E(d,e);v>0&&9999>v?e[v]={}:0>=v&&(e[0]={},t(e,p,l,n,o,u));for(var i=0>v?1:v+1;i<p.length;i++)e[i]={};return _(e,p,l,0,p.length),v}function n(e){for(var t=[],l=0;e>l;l++)t.push({});return t}function o(e){for(var t={},l=0;l<e.length;l++){var n=L(e[l].date);e[l].date=n,t[n]=e[l]}return t}function u(e){for(var t=0;t<e.length;t++){var l=R(e[t].date);e[t].date=l}}function v(e){for(var t=0;t<e.length;t++)for(var l in e[t])"cl"!=l&&"ol"!=l&&"pl"!=l&&"ov_lv"!=l&&"ov_debug"!=l&&"cover_line"!=l&&null!=e[t][l]&&(e[t][l]=R(e[t][l]));return e}function a(e){for(var t=0;t<e.length;t++)for(var l in e[t])"cl"!=l&&"ol"!=l&&"pl"!=l&&"ov_lv"!=l&&"ov_debug"!=l&&"cover_line"!=l&&null!=e[t][l]&&(e[t][l]=L(e[t][l]));return e}function i(e,p,t,l,n,u){for(var a=0,i=o(l),f=0;f<l.length;f++){var b=c(f,e,p,t,l,i,l[f].date,!0),s=b+n;0>b&&(s=n),9999>b&&s>b&&_(e,p,t,b,s,i)}return 0===a&&u>=0&&_(e,p,t,u,u+n,i),e=v(e),p=v(p),t=v(t),{a:e,p:p,t:t}}function f(e,p,t,l,n,u){for(var a=o(l),i=0;i<l.length;i++){var f=c(i,e,p,t,l,a,l[i].date,!1),b=f+n;0>f&&(b=n),9999>f&&b>f&&_(e,p,t,f,b,a)}return u>=0&&_(e,p,t,u,u+n,a),e=v(e),p=v(p),t=v(t),{a:e,p:p,t:t}}function c(e,t,p,l,n,o,u,v){var d=n[e],a=d.date,i=j(d.date,p);if(0>i)return 9999;var f=!1;return 13==d.period||11==d.period||1!=d.period%4&&3!=d.period%4?i>=0&&9999>i&&(f=d.ovulation_test?k(d,i,a,t,l)?!0:f:x(d,i,a,t,l,o)?!0:f,d.cervical_mucus&&(f=P(d,i,a,t,l,n,e)?!0:f)):(i=E(a,t),f=v?M(d,i,a,t,p)?!0:f:y(d,i,a,t,p)?!0:f),f?i-1:9999}function b(e,t){for(var l=[],n=2;n>=0;n--)t[e-n]&&t[e-n].temperature>10&&l.push(t[e-n].temperature);if(3!=l.length)return null;var o=l.indexOf(Math.min.apply(Math,l));return o>=0?e-(2-o):null}function s(e,t){for(var l={},n=null,o=null,u=1;8>=u;u++)t[e-u]&&t[e-u].temperature>10&&(l[e-u]=t[e-u].temperature,o=null==o?l[e-u]:Math.max(o,l[e-u]));if(Object.keys(l).length<6)return null;for(var u=0;3>u;u++)if(t[e+u]&&t[e+u].temperature>10){n=null==n?t[e+u].temperature:Math.min(n,t[e+u].temperature);break}return null!=n&&null!=o&&n-o>=.055556?o+.03:null}function h(e,t){var l=s(e,t);return l||(l=s(e+1,t)),l}function _(e,p,t,l,n,o){0>l&&(l=0),n>p.length&&(n=p.length),o||(o={});for(var u=l;n>u;u++){if(u>0&&(t[u].pb=p[u-1].pb+p[u-1].cl,t[u].cl=V(u,p,"cl",e[0]),t[u].pl=V(u,p,"pl",e[0]),t[u].ol=V(u,p,"ol",e[0])),t[u].pe=t[u].pb+Math.round(t[u].pl),t[u].ov=Math.max(t[u].pe+3,t[u].pb+Math.round(t[u].cl)-Math.round(t[u].ol)),t[u].fb=Math.max(t[u].pe+2,t[u].ov-5),t[u].fe=Math.max(t[u].pe+3,t[u].ov+1),t[u].pk=Math.max(t[u].pe+2,t[u].ov-1),p[u].pb=null!=e[u].pb?e[u].pb:p[u-1].ov+p[u-1].ol,u>0&&(p[u-1].cl=p[u].pb-p[u-1].pb),p[u].ol=null!=e[u].ov&&u+1<e.length&&e[u+1].pb?e[u+1].pb-e[u].ov:null!=e[u].ol?e[u].ol:Math.round(V(u,p,"ol",e[0])),p[u].cl=u<p.length-1&&null!=e[u+1].pb?e[u+1].pb-p[u].pb:null!=e[u].ov?e[u].ov-p[u].pb+p[u].ol:e[u].cl?e[u].cl:Math.round(V(u,p,"cl",e[0])),p[u].pl=null!=e[u].pb&&null!=e[u].pe?e[u].pe-e[u].pb:e[u].pl?e[u].pl:null!=e[u].pe?e[u].pe-p[u].pb:Math.round(V(u,p,"pl",e[0])),p[u].pe=null!=e[u].pe?e[u].pe:p[u].pb+p[u].pl,p[u].ov_debug={},null!=e[u].ov){if(p[u].ov=e[u].ov,p[u].ov_debug.base="OV from user input: "+g(e[u].ov_lv)+"; ",3==e[u].ov_lv){var v=b(p[u].ov,o);null!=v&&v!=p[u].ov&&(p[u].ov_debug.base+="Refined by bbt from "+R(p[u].ov),p[u].ov=v)}}else if(u+1<e.length&&null!=e[u+1].pb){p[u].ov=e[u+1].pb-p[u].ol,p[u].ov_debug.base="OV = next PB - OL; ";var v=b(p[u].ov,o);null!=v&&v-p[u].ov<=-2&&(p[u].ov_debug.base+="Refined by bbt from "+R(p[u].ov),p[u].ov=v)}else{p[u].ov=p[u].pb+p[u].cl-p[u].ol,p[u].ov_debug.base="OV = PB + CL - OL(CL is predicted); ";var v=b(p[u].ov,o);null!=v&&v!=p[u].ov&&(p[u].ov_debug.base+="Refined by bbt from "+R(p[u].ov),p[u].ov=v)}if(p[u].ov_debug.neg_ov="",p[u].ov_debug.restrict="",null==e[u].ov||!e[u].ov_lv||e[u].ov_lv>2){for(var a=p[u].ov,i=0;100>i;i++){var f=m(p[u].ov,o);if(f==p[u].ov)break;if(u+1<e.length&&e[u+1].pb&&e[u+1].pb<f){p[u].ov=e[u+1].pb-1;break}p[u].ov=f}a!=p[u].ov&&(p[u].ov_debug.neg_ov="Neg test delays ov by "+(p[u].ov-a)+" days; ");var c=8;a=p[u].ov,p[u].ov=Math.min(t[u].ov+c,p[u].ov),p[u].ov!=a&&(p[u].ov_debug.restrict+="restricted by initial predicted OV("+R(t[u].ov)+"),")}if(p[u].ov=Math.max(p[u].ov,p[u].pe+1),p[u].ov==p[u].pe+1&&(p[u].ov_debug.restrict+="restricted by PE("+R(p[u].pe)+"),"),null!=e[u].ov&&(3==e[u].ov_lv||1==e[u].ov_lv||2==e[u].ov_lv)){var s=h(p[u].ov,o);s&&(p[u].cover_line=s)}p[u].fe=p[u].ov+1,u+1<e.length&&null!=e[u+1].pb&&(p[u].ov=Math.min(p[u].ov,e[u+1].pb-1),p[u].ov==e[u+1].pb-1&&(p[u].ov_debug.restrict+="restricted by next PB("+R(e[u+1].pb)+"),"),p[u].fe=Math.min(p[u].fe,e[u+1].pb-1),p[u].ol=e[u+1].pb-p[u].ov),p[u].fb=null!=e[u].fb?Math.min(p[u].ov-1,Math.max(e[u].fb,p[u].pe+1)):Math.max(p[u].ov-5,p[u].pe+1),p[u].pk=null!=e[u].pk?e[u].pk:p[u].ov-1}}function g(e){return 1==e?"1 day after POS":2==e?"3 days after HIGH(clearblue)":3==e?"Temperature spike":4==e?"Cervical mucus":""}function m(t,l){for(var n=t,o=0;4>o;o++){var u=l[n-o];if(u&&2==e(u.ovulation_test,10)){if(1!=Math.floor(u.ovulation_test/10)&&1>=o)return t+2-o;if(1==Math.floor(u.ovulation_test/10))return t+4-o}}return t}function M(d,e,t,l){var n=E(t,l);if(0>n)return!1;var o=l[n].pb,u=l[n].pe;return 13!=d.period&&1==d.period%4?t==o||n+1>=l.length?!1:(l[n+1].pb=t,l[n+1].pe=null,l[n+1].fb=null,l[n+1].fe=null,l[n+1].ov=null,l[n+1].pk=null,!0):11!=d.period&&3==d.period%4&&(!u||u-t>=0)&&o&&t-o>0?t-1==u||n>=l.length?!1:(l[n].pe=t-1,l[n].fb=null,l[n].fe=null,l[n].ov=null,l[n].pk=null,!0):!1}function y(d,e,t,l,p){if(0>e||e>=l.length)return!1;var n=l[e].pb,o=l[e].pe;return 13!=d.period&&1==d.period%4?(n?15>=t-n?(l[e].pb=t,l[e].pe=null,l[e].fb=null,l[e].fe=null,l[e].ov=null,l[e].pk=null):e+1<l.length&&(l[e+1].pb=t,l[e+1].pe=null,l[e+1].fb=null,l[e+1].fe=null,l[e+1].ov=null,l[e+1].pk=null):t-p[e].pb<=20?(l[e].pb=t,l[e].pe=null,l[e].fb=null,l[e].fe=null,l[e].ov=null,l[e].pk=null):e+1<l.length&&(l[e+1].pb=t,l[e+1].pe=null,l[e+1].fb=null,l[e+1].fe=null,l[e+1].ov=null,l[e+1].pk=null),!0):11!=d.period&&3==d.period%4&&(!o||o-t>=0)&&n&&t-n>0?(l[e].pe=t-1,l[e].fb=null,l[e].fe=null,l[e].ov=null,l[e].pk=null,!0):!1}function k(d,t,l,n,o){if(1==e(d.ovulation_test,10)&&(!n[t].ov_lv||n[t].ov_lv>1)){var u=o[t].cl<37?8:12,v=l-o[t].ov;if(Math.abs(v)<=u)return n[t].ov=l+1,n[t].ov_lv=1,!0}if(3==e(d.ovulation_test,10)&&(!n[t].ov_lv||n[t].ov_lv>2)){var v=l-o[t].ov;if(-3>v||v>0)return n[t].ov=l+3,n[t].ov_lv=2,!0}return!1}function x(d,e,t,l,n,o){return(!l[e].ov||l[e].ov_lv>3)&&d.temperature&&t>=n[e].fb&&t<n[e].pb+n[e].cl&&D(t,o)?(l[e].ov=t-1,l[e].ov_lv=3,!0):!1}function O(e,t){for(var l={},n={},o=0;4>o;o++)t[e-o]&&t[e-o].temperature>10&&(l[e-o]=t[e-o].temperature);for(var o=4;10>o;o++)t[e-o]&&t[e-o].temperature>10&&(n[e-o]=t[e-o].temperature);if(Object.keys(l).length<3||Object.keys(n).length<5)return!1;if(!l[e]||!l[e-1]||!l[e-2])return!1;l[e-3]&&(n[e-3]=l[e-3]),n[e-9]=null;var u=Math.max(n[e-3]?n[e-3]:0,n[e-4]?n[e-4]:0,n[e-5]?n[e-5]:0,n[e-6]?n[e-6]:0,n[e-7]?n[e-7]:0,n[e-8]?n[e-8]:0);return l[e]>u+.1111111&&l[e-1]>u&&l[e-2]>u}function T(e,t){for(var l={},n={},o=0;4>o;o++)t[e-o]&&t[e-o].temperature>10&&(l[e-o]=t[e-o].temperature);for(var o=4;10>o;o++)t[e-o]&&t[e-o].temperature>10&&(n[e-o]=t[e-o].temperature);if(Object.keys(l).length<3||Object.keys(n).length<5)return!1;if(!(l[e]&&l[e-1]&&l[e-2]&&l[e-3]))return!1;var u=Math.max(n[e-4]?n[e-4]:0,n[e-5]?n[e-5]:0,n[e-6]?n[e-6]:0,n[e-7]?n[e-7]:0,n[e-8]?n[e-8]:0,n[e-9]?n[e-9]:0);return l[e]>u&&l[e-1]>u&&l[e-2]>u&&l[e-3]>u}function D(e,t){return O(e,t)||T(e,t)}function P(d,e,t,l,n,o,u){var v=!1;if((!l[e].ov||l[e].ov_lv>4)&&d.cervical_mucus&&d.cervical_mucus>1){var a=B(d.cervical_mucus),i=I(d.cervical_mucus);if(t>=n[e].fb&&t<n[e].pb+n[e].cl&&u>0&&o[u-1].cervical_mucus&&o[u-1].cervical_mucus>1&&3>i&&3>a){var f=B(o[u-1].cervical_mucus),c=I(o[u-1].cervical_mucus);if(3==c&&3==f){var b=n[e].cl<37?5:12,s=t-n[e].ov;Math.abs(s)<=b&&(l[e].ov=t,l[e].ov_lv=4),v=!0}}}return v}function B(e){var t=255&e;return 33>=t?1:67>=t?2:3}function I(e){var t=e>>8&255;return 33>=t?1:67>=t?2:3}function w(e){var t=e.toISOString().substring(0,10);return t.replace(new RegExp("-","g"),"/")}function C(e,t){var d=(e.split("/"),new Date(e+" 00:00:00 GMT"));return w(new Date(d.getTime()+864e5*t))}function G(e,t){var l=new Date(e+" 00:00:00 GMT"),n=new Date(t+" 00:00:00 GMT");return Math.round((l-n)/864e5)}function L(e){return G(e,"2013/01/01")}function R(e){return C("2013/01/01",e)}function j(e,p){for(var t=0;t<p.length;t++){var l=p[t].pb,n=p[t].pb+p[t].cl;if(l>e)return t-1;if(n>e)return t}return 9999}function E(e,t){if(t[0].pb&&e<t[0].pb)return-1;var l=1;for(l=1;l<t.length;l++){var n=t[l].pb;if(l==t.length-1&&e>=n)return l;if(!n)return l-1;if(n>e)return l-1}}function H(e,t){return t>=WEIGHT_DICT[e].length?0:WEIGHT_DICT[e][t]}function V(e,p,t,l){for(var n=0,o=0,u=e-1;u>=0;u--){var v=1;"ol"==t&&p[u][t]<6||"ol"==t&&p[u][t]>=20?v=0:"ol"==t&&p[u][t]>17?v=.3:"cl"==t&&p[u][t]<15?v=0:"cl"==t&&p[u][t]>90?v=0:"cl"==t&&p[u][t]>45&&(v=.3);var a=H(t,u);n+=a*p[u][t]*v,o+=a*v}return o>0?n/o:l[t]&&l[t]>0?l[t]:"ol"==t?14:"cl"==t?28:"pl"==t?4:void 0}function S(){return"latest"}function predictRulesMain(e,l,o,v,a,f){l=L(l);for(var c=Math.round((new Date-new Date("2013/01/01 00:00:00 GMT"))/864e5),b=0;b<e.length;b++)if(13!=e[b].period&&e[b].period%4==1){var s=L(e[b].date);if(l>s){l=s;break}}var h=18;c-180>l&&(h=24);var g=n(h),p=n(h),m=n(h);if(t(g,p,m,l,o,v),_(g,p,m,0,h),i(g,p,m,e,h,0),p.length>0&&L(p[p.length-1].pb)<=c+90){u(e);var M=c+90-L(p[p.length-1].pb),y=Math.ceil(M/28)+3;g=n(h+y),p=n(h+y),m=n(h+y),t(g,p,m,l,o,v),_(g,p,m,0,h+y),i(g,p,m,e,h+y,0)}for(var b=0;b<p.length;b++)if(null!=p[b].pb&&p[b].cl){var k=L(p[b].pb);if(k-c>400){g=g.slice(0,b+1),p=p.slice(0,b+1),m=m.slice(0,b+1);break}}if(f&&f.settings&&2==f.settings.current_status&&f.settings.last_pregnant_date)for(var x=L(f.settings.last_pregnant_date),b=0;b<p.length;b++)if(null!=p[b].pb&&p[b].cl){var k=L(p[b].pb);if(x>=k&&k+p[b].cl>=x){g=g.slice(0,b+1),p=p.slice(0,b+1),m=m.slice(0,b+1);break}}return{a:g,p:p,t:m}}WEIGHT_DICT={pl:[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],cl:[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],ol:[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]},"undefined"==typeof exports&&(exports={}),exports.Predictor=function(){return this.testOnly={_refinePredictedOvByBbt:b,_rawToDict:o,_coverLineKernel0:s},this._findPbIndexBefore=j,this._updateByPeriod=y,this._updateByOvTest=k,this._tempRise=D,this._updateByTemperature=x,this._updateByCervicalMucus=P,this._weightedAvg=V,this.emptyCycles=n,this.initPredict=t,this.predictCycle=_,this.applyDailyData=f,this.applyDailyDataAfterMigration=i,this.datePlusLength=C,this.predictRulesMain=predictRulesMain,this._dateToIndex=L,this._indexToDate=R,this};
